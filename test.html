<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHRI â€” My Account (Secure)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  html, body { margin:0; padding:0; width:100%; font-family:"Segoe UI", Arial, sans-serif; background:#fff8f0; display:flex; flex-direction:column; min-height:100vh; }
  .navbar { background:linear-gradient(to right,#ff512f,#f09819); position:sticky; top:0; z-index:1000; width:100%; }
  .navbar-brand img { height:50px; }
  .navbar-nav .nav-link { color:white !important; margin:0 10px; font-weight:500; }
  main { flex:1; display:flex; flex-direction:column; justify-content:center; padding:20px; }
  .login-container, .user-card { max-width:600px; margin:20px auto; padding:30px; background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  .login-container h2, .user-card h3 { text-align:center; margin-bottom:20px; color:#ff512f; }
  footer { background:linear-gradient(to right,#ff512f,#f09819); color:white; text-align:center; padding:15px; width:100%; margin-top:auto; }
  table { width:100%; }
  th, td { text-align:center; }
  @media(max-width:576px){ .login-container,.user-card{padding:15px;} }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><img src="images/shriapp.png" alt="SHRI Logo"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        <li class="nav-item"><a class="nav-link" href="privacy.html">Privacy Policy</a></li>
        <li class="nav-item"><a class="nav-link active" href="#">My Account</a></li>
      </ul>
    </div>
  </div>
</nav>

<main>
<!-- Login Form -->
<div class="login-container" id="loginBox">
  <h2>Login to Your Account</h2>
  <form id="loginForm">
    <div class="mb-3"><label for="username" class="form-label">Username</label><input type="text" id="username" class="form-control" required></div>
    <div class="mb-3"><label for="password" class="form-label">Password</label><input type="password" id="password" class="form-control" required></div>
    <button type="submit" class="btn btn-warning w-100">Login</button>
  </form>
</div>

<!-- Dashboard -->
<div class="user-card d-none" id="userCard">
  <h3>Welcome, <span id="displayUsername"></span></h3>
  <div class="row text-center mb-4">
    <div class="col"><strong>Pali</strong><div id="pali">0</div></div>
    <div class="col"><strong>Upad</strong><div id="upad">0</div></div>
    <div class="col"><strong>Balance</strong><div id="balance">0</div></div>
  </div>
  <div id="employeeSelectDiv" class="mb-3 d-none">
    <label class="form-label">Select Employee</label>
    <select id="employeeSelect" class="form-select"></select>
  </div>
  <table class="table table-striped" id="detailTable">
    <thead><tr><th>Date</th><th>Shift</th><th>Customer</th><th>Detail</th><th>Amount</th></tr></thead>
    <tbody></tbody>
  </table>
  <button class="btn btn-success w-100 d-none" id="salarySlipBtn">Download Salary Slip</button>
  <button class="btn btn-danger w-100 mt-2" id="logoutBtn">Logout</button>
</div>
</main>

<footer><p>&copy; 2025 SHRI. All Rights Reserved.</p></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec";
let currentUser=null, registrationData=[], dailyData=[];

// Fetch from Apps Script Web App
async function fetchData(sheetName){
  const res=await fetch(`${SHEET_API_URL}?sheet=${sheetName}`);
  if(!res.ok) throw new Error("Fetch failed");
  return await res.json();
}

// Calculate total shifts (pali)
function calculatePali(rows){ return rows.reduce((a,r)=>a+["Morning","Evening","Night"].filter((_,i)=>r[i+1]).length,0); }

// Render dashboard
function updateDashboard(user){
  const username=user.username, role=user.role, rate=parseFloat(user.rate);
  const tbody=document.querySelector("#detailTable tbody");
  tbody.innerHTML="";
  let pali=0, upad=0, balance=0;
  const records=dailyData.filter(r=>r.username===username);
  records.forEach(r=>{
    const shifts=["Morning","Evening","Night"].filter((s,i)=>r[s.toLowerCase()]!="").join(" ");
    pali+=["Morning","Evening","Night"].filter(s=>r[s.toLowerCase()]!="").length;
    upad+=parseFloat(r.amount)||0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date}</td><td>${shifts}</td><td>${r.customer}</td><td>${r.detail}</td><td>${r.amount||0}</td>`;
    tbody.appendChild(tr);
  });
  balance=pali*rate-upad;
  document.getElementById("pali").innerText=pali;
  document.getElementById("upad").innerText=upad;
  document.getElementById("balance").innerText=balance;

  if(role.toLowerCase()==="senior"){
    document.getElementById("employeeSelectDiv").classList.remove("d-none");
    const select=document.getElementById("employeeSelect");
    select.innerHTML='<option value="">Select Employee</option>';
    registrationData.filter(u=>u.role.toLowerCase()==="employee").forEach(u=>{
      select.innerHTML+=`<option value="${u.username}">${u.username}</option>`;
    });
    select.onchange=()=>{
      const emp=registrationData.find(e=>e.username===select.value);
      if(emp) updateDashboard(emp);
    };
    document.getElementById("salarySlipBtn").classList.remove("d-none");
    document.getElementById("salarySlipBtn").onclick=()=>generatePdf(records,username,rate,upad,balance,pali);
  }else{
    document.getElementById("employeeSelectDiv").classList.add("d-none");
    document.getElementById("salarySlipBtn").classList.add("d-none");
  }
}

// Generate salary slip
function generatePdf(data, username, rate, upad, balance, pali){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text(`Salary Slip: ${username}`, 20,20);
  doc.setFontSize(12);
  doc.text(`Pali: ${pali}`,20,30);
  doc.text(`Rate: ${rate}`,20,36);
  doc.text(`Upad: ${upad}`,20,42);
  doc.text(`Balance: ${balance}`,20,48);
  doc.text("Details:",20,58);
  let y=64;
  data.forEach(r=>{
    const shifts=["Morning","Evening","Night"].filter((s,i)=>r[s.toLowerCase()]!="").join(" ");
    doc.text(`${r.date} | ${shifts} | ${r.customer} | ${r.detail} | ${r.amount||0}`,20,y);
    y+=6;
  });
  doc.save(`Salary_Slip_${username}.pdf`);
}

// Login handler
async function handleLogin(e){
  e.preventDefault();
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  const hashed=sha256(password);
  try{
    const user=registrationData.find(u=>u.username===username && u.passwordHash===hashed);
    if(user){
      sessionStorage.setItem("shriUser", JSON.stringify(user));
      currentUser=user;
      document.getElementById("loginBox").classList.add("d-none");
      document.getElementById("userCard").classList.remove("d-none");
      document.getElementById("displayUsername").innerText=username;
      updateDashboard(user);
    }else alert("Invalid username or password!");
  }catch(err){ console.error(err); alert("Login error."); }
}

// Logout
function logout(){
  sessionStorage.removeItem("shriUser");
  document.getElementById("loginBox").classList.remove("d-none");
  document.getElementById("userCard").classList.add("d-none");
  document.getElementById("loginForm").reset();
}

// Session persistence
document.addEventListener("DOMContentLoaded",async()=>{
  try{
    [registrationData,dailyData]=await Promise.all([fetchData("registration"),fetchData("daily")]);
  }catch(e){ alert("Data load failed."); console.error(e); }

  const saved=sessionStorage.getItem("shriUser");
  if(saved){
    currentUser=JSON.parse(saved);
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("userCard").classList.remove("d-none");
    document.getElementById("displayUsername").innerText=currentUser.username;
    updateDashboard(currentUser);
  }
});

document.getElementById("loginForm").addEventListener("submit",handleLogin);
document.getElementById("logoutBtn").addEventListener("click",logout);
</script>
</body>
</html>
