<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHRI â€” My Account</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  html, body { margin:0; padding:0; width:100%; font-family: "Segoe UI", Arial, sans-serif; background:#fff8f0; display:flex; flex-direction:column; min-height:100vh; }
  .navbar { background: linear-gradient(to right, #ff512f, #f09819); width:100%; }
  .navbar-brand img { height:50px; }
  .navbar-nav .nav-link { color:white !important; margin:0 10px; font-weight:500; }
  main { flex:1; padding:20px; }
  .login-container, .user-card { max-width:700px; margin:20px auto; padding:30px; background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  .login-container h2, .user-card h3 { text-align:center; margin-bottom:20px; color:#ff512f; }
  footer { background: linear-gradient(to right, #ff512f, #f09819); color:white; text-align:center; padding:15px; width:100%; }
  .profile-photo { width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid #f09819; margin:0 auto 15px; display:block; }
  table { width:100%; }
  th, td { text-align:center; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html"><img src="images/shriapp.png" alt="SHRI Logo"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        <li class="nav-item"><a class="nav-link" href="privacy.html">Privacy Policy</a></li>
        <li class="nav-item"><a class="nav-link active" href="myaccount.html">My Account</a></li>
      </ul>
    </div>
  </div>
</nav>

<main>
<!-- Login Form -->
<div class="login-container" id="loginBox">
  <h2>My Account Login</h2>
  <form id="loginForm">
    <div class="mb-3"><label for="username" class="form-label">Username</label><input type="text" id="username" class="form-control" required></div>
    <div class="mb-3"><label for="password" class="form-label">Password</label><input type="password" id="password" class="form-control" required></div>
    <button type="submit" class="btn btn-warning w-100">Login</button>
  </form>
</div>

<!-- User Dashboard -->
<div class="user-card d-none" id="userCard">
  <img id="profilePhoto" class="profile-photo" src="https://via.placeholder.com/100" alt="Profile Photo">
  <h3>Welcome, <span id="displayUsername"></span></h3>

  <!-- Top Summary -->
  <div class="row text-center mb-4">
    <div class="col"><strong>Pali</strong><div id="pali">0</div></div>
    <div class="col"><strong>Upad</strong><div id="upad">0</div></div>
    <div class="col"><strong>Balance</strong><div id="balance">0</div></div>
  </div>

  <!-- Employee Dropdown for Senior -->
  <div class="mb-3 d-none" id="employeeSelectDiv">
    <label for="employeeSelect" class="form-label">Select Employee</label>
    <select id="employeeSelect" class="form-select"></select>
  </div>

  <!-- Detail Table -->
  <table class="table table-striped" id="detailTable">
    <thead>
      <tr><th>Date</th><th>Shift</th><th>Customer</th><th>Detail</th><th>Amount</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn btn-success w-100 d-none" id="salarySlipBtn">Download Salary Slip</button>
  <button class="btn btn-danger w-100 mt-2" id="logoutBtn">Logout</button>
</div>
</main>

<footer>
  <p>&copy; 2025 SHRI. All Rights Reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const registrationCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLdyByIkGxCAIw8k8FQD8E9Tsnbc3DYks0dNgEhJcRikon38lOsqb4ESJAOlC7HwJylivfI49wrG5A/pub?gid=1862107016&single=true&output=csv";
const dailyCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLdyByIkGxCAIw8k8FQD8E9Tsnbc3DYks0dNgEhJcRikon38lOsqb4ESJAOlC7HwJylivfI49wrG5A/pub?gid=1370536424&single=true&output=csv";

let registrationData=[], dailyData=[];
let currentUser=null;

function fetchCsv(url){ return fetch(url).then(r=>r.text()); }
function parseCsv(data){ return data.trim().split("\n").map(r=>r.split(",")); }
function calculatePali(row){ return ['Morning','Evening','Night'].reduce((sum,col,i)=>sum+(row[i+1]&&!isNaN(row[i+1])?parseInt(row[i+1]):0),0); }

function updateDashboard(user){
  const username=user[0], role=user[13], rate=parseFloat(user[3]);
  const photoUrl = user[24] && user[24].startsWith("http") ? user[24] : "https://via.placeholder.com/100";
  document.getElementById("profilePhoto").src = photoUrl;

  const tbody=document.querySelector("#detailTable tbody");
  tbody.innerHTML="";
  let pali=0, upad=0;
  let filtered=dailyData.filter(r=>r[4]===username);
  filtered.forEach(r=>{
    const shifts=["Morning","Evening","Night"].map((s,i)=>r[i+1]&&r[i+1]!=""?s:"").filter(s=>s).join(" ");
    pali+=calculatePali(r);
    upad+=r[7]?parseFloat(r[7]):0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r[0]}</td><td>${shifts}</td><td>${r[6]}</td><td>${r[5]}</td><td>${r[7]||0}</td>`;
    tbody.appendChild(tr);
  });
  const balance=pali*rate-upad;
  document.getElementById("pali").innerText=pali;
  document.getElementById("upad").innerText=upad;
  document.getElementById("balance").innerText=balance;

  if(role.toLowerCase()=="senior"){
    document.getElementById("employeeSelectDiv").classList.remove("d-none");
    const select=document.getElementById("employeeSelect");
    select.innerHTML='<option value="">Select Employee</option>';
    registrationData.forEach(r=>{ if(r[13].toLowerCase()=="employee") select.innerHTML+=`<option value="${r[0]}">${r[0]}</option>`; });
    select.addEventListener("change",()=>{ 
      const emp=registrationData.find(u=>u[0]===select.value);
      if(emp) updateDashboard(emp);
    });
    document.getElementById("salarySlipBtn").classList.remove("d-none");
    document.getElementById("salarySlipBtn").onclick=()=>generatePdf(filtered, username, rate, upad, balance, pali, photoUrl);
  }else{
    document.getElementById("employeeSelectDiv").classList.add("d-none");
    document.getElementById("salarySlipBtn").classList.add("d-none");
  }
}

function generatePdf(data, username, rate, upad, balance, pali, photoUrl){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16); doc.text(`Salary Slip: ${username}`, 20,20);
  if(photoUrl){
    doc.addImage(photoUrl,"JPEG",150,10,40,40); // top right corner
  }
  doc.setFontSize(12);
  doc.text(`Pali (Shifts): ${pali}`, 20,40);
  doc.text(`Rate: ${rate}`, 20,46);
  doc.text(`Upad: ${upad}`, 20,52);
  doc.text(`Balance: ${balance}`, 20,58);
  doc.text("Details:",20,68);
  let y=74;
  data.forEach(r=>{
    const shifts=["Morning","Evening","Night"].map((s,i)=>r[i+1]&&r[i+1]!=""?s:"").filter(s=>s).join(" ");
    doc.text(`${r[0]} | ${shifts} | ${r[6]} | ${r[5]} | ${r[7]||0}`,20,y); y+=6;
    if(y>280){ doc.addPage(); y=20; }
  });
  doc.save(`Salary_Slip_${username}.pdf`);
}

document.getElementById("loginForm").addEventListener("submit",function(e){
  e.preventDefault();
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  const user=registrationData.find(r=>r[0]===username && (r[1]===password || r[23]===password));
  if(user){ currentUser=user;
    document.getElementById("loginBox").classList.add("d-none");
    document.getElementById("userCard").classList.remove("d-none");
    document.getElementById("displayUsername").innerText=username;
    updateDashboard(user);
  }else{ alert("Invalid username or password!"); }
});

document.getElementById("logoutBtn").addEventListener("click",()=>{
  currentUser=null;
  document.getElementById("loginBox").classList.remove("d-none");
  document.getElementById("userCard").classList.add("d-none");
  document.getElementById("loginForm").reset();
});

Promise.all([fetchCsv(registrationCsv), fetchCsv(dailyCsv)]).then(([reg,daily])=>{
  registrationData=parseCsv(reg);
  dailyData=parseCsv(daily);
});
</script>
</body>
</html>
