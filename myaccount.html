<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHRI — My Account</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #fff8f0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
/* Sticky Navbar */
.navbar {
  background: linear-gradient(to right, #ff512f, #f09819);
  position: sticky;
  top: 0;
  z-index: 1000;
}
.navbar-brand img { height:50px; }
.navbar-nav .nav-link {
  color: white !important;
  margin: 0 10px;
  font-weight: 500;
}
/* Main content flex */
main { flex: 1; display: flex; flex-direction: column; justify-content: center; }
/* Login box */
.login-container {
  max-width: 400px;
  margin: 60px auto;
  padding: 30px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.login-container h2 { text-align: center; margin-bottom: 20px; color: #ff512f; }
/* User card */
.user-card {
  max-width: 800px;
  margin: 40px auto;
  padding: 25px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
footer {
  background: linear-gradient(to right, #ff512f, #f09819);
  color: white;
  text-align: center;
  padding: 15px;
  margin-top: auto;
}
table { width: 100%; }
th, td { text-align: center; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <img src="images/shriapp.png" alt="SHRI Logo">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        <li class="nav-item"><a class="nav-link" href="privacy.html">Privacy Policy</a></li>
        <li class="nav-item"><a class="nav-link active" href="myaccount.html">My Account</a></li>
      </ul>
    </div>
  </div>
</nav>

<main>
  <!-- Login Form -->
  <div class="login-container" id="loginBox">
    <h2>My Account</h2>
    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" id="username" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" id="password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-warning w-100">Login</button>
    </form>
  </div>

  <!-- User Data -->
  <div class="user-card d-none" id="userCard">
    <h3 class="mb-3">Welcome, <span id="displayUsername"></span></h3>

    <div id="summary" class="mb-3">
      <p><strong>Pali (Shifts):</strong> <span id="pali">0</span></p>
      <p><strong>Upad:</strong> ₹<span id="upad">0</span></p>
      <p><strong>Balance:</strong> ₹<span id="balance">0</span></p>
    </div>

    <!-- Employee dropdown for senior -->
    <div id="employeeSelectDiv" class="mb-3 d-none">
      <label for="employeeSelect" class="form-label">Select Employee</label>
      <select id="employeeSelect" class="form-select"></select>
    </div>

    <!-- Detail Table -->
    <table class="table table-bordered table-striped">
      <thead class="table-warning">
        <tr>
          <th>Date</th>
          <th>Morning</th>
          <th>Evening</th>
          <th>Night</th>
          <th>Customer</th>
          <th>Detail</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="detailTable"></tbody>
    </table>

    <button class="btn btn-danger w-100 mt-3" id="logoutBtn">Logout</button>
  </div>
</main>

<footer>
  <p>&copy; 2025 SHRI. All Rights Reserved.</p>
</footer>

<script>
const regUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbEW2FWMXnxb8SKLMv0rxL3f0ZI8NntDpEhh9um5YAoZ7Nzki3NGFbReLqaV8Fkw/pub?gid=1862107016&single=true&output=csv";
const dailyUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbEW2FWMXnxb8SKLMv0rxL3f0ZI8NntDpEhh9um5YAoZ7Nzki3NGFbReLqaV8Fkw/pub?gid=1370536424&single=true&output=csv";

let registrationData = [], dailyData = [];

async function fetchCSV(url) {
  const resp = await fetch(url);
  const text = await resp.text();
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows.shift();
  return rows.map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
    return obj;
  });
}

// Initialize data
Promise.all([fetchCSV(regUrl), fetchCSV(dailyUrl)]).then(([reg, daily])=>{
  registrationData = reg;
  dailyData = daily;
});

// Helper to calculate totals
function calculateTotals(username) {
  const regRow = registrationData.find(r=>r["Username"]===username);
  if(!regRow) return {pali:0, upad:0, balance:0};

  let pali=0, upad=0;
  dailyData.forEach(row=>{
    if(row["Employee Username"]===username){
      let morning=parseInt(row["Morning"]||0);
      let evening=parseInt(row["Evening"]||0);
      let night=parseInt(row["Night"]||0);
      pali += morning+evening+night;
      if(row["Amount"]) upad += parseFloat(row["Amount"]);
    }
  });
  const rate=parseFloat(regRow["Rate"]||0);
  const balance=(pali*rate)-upad;
  return {pali, upad, balance};
}

// Populate detail table
function populateDetail(username){
  const tbody=document.getElementById("detailTable");
  tbody.innerHTML="";
  dailyData.forEach(row=>{
    if(row["Employee Username"]===username){
      const tr=document.createElement("tr");
      ["Date","Morning","Evening","Night","Customer","Detail","Amount"].forEach(col=>{
        const td=document.createElement("td");
        td.innerText=row[col]||"";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
  });
}

document.getElementById("loginForm").addEventListener("submit", function(e){
  e.preventDefault();
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  const user=registrationData.find(u=>u["Username"]===username && u["Password"]===password);
  if(!user){
    alert("Username or password incorrect!");
    return;
  }

  document.getElementById("loginBox").classList.add("d-none");
  document.getElementById("userCard").classList.remove("d-none");
  document.getElementById("displayUsername").innerText=username;

  const totals=calculateTotals(username);
  document.getElementById("pali").innerText=totals.pali;
  document.getElementById("upad").innerText=totals.upad;
  document.getElementById("balance").innerText=totals.balance;

  populateDetail(username);

  // Senior dropdown
  if(user["Role"]==="Senior"){
    const div=document.getElementById("employeeSelectDiv");
    const sel=document.getElementById("employeeSelect");
    div.classList.remove("d-none");
    sel.innerHTML="";
    registrationData.filter(u=>u["Role"]==="Employee").forEach(emp=>{
      const opt=document.createElement("option");
      opt.value=emp["Username"];
      opt.innerText=emp["Username"];
      sel.appendChild(opt);
    });
    sel.addEventListener("change", function(){
      const uname=this.value;
      const t=calculateTotals(uname);
      document.getElementById("pali").innerText=t.pali;
      document.getElementById("upad").innerText=t.upad;
      document.getElementById("balance").innerText=t.balance;
      populateDetail(uname);
      document.getElementById("displayUsername").innerText=uname;
    });
  }
});

document.getElementById("logoutBtn").addEventListener("click", function(){
  document.getElementById("userCard").classList.add("d-none");
  document.getElementById("loginBox").classList.remove("d-none");
  document.getElementById("loginForm").reset();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
