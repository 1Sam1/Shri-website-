<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHRI â€” My Account</title>

<!-- Inline Bootstrap & Custom CSS -->
<style>
body{font-family:"Segoe UI",Arial,sans-serif;background:#fff8f0;display:flex;flex-direction:column;min-height:100vh;margin:0}
.container{width:90%;max-width:1200px;margin:0 auto}
.navbar{background:linear-gradient(to right,#ff512f,#f09819);position:sticky;top:0;z-index:1000;padding:10px 0;color:white;display:flex;justify-content:space-between;align-items:center}
.navbar img{height:50px}
.nav-link{color:white;text-decoration:none;margin:0 10px;font-weight:500}
.nav-link.active{font-weight:bold;text-decoration:underline}
.login-container,.user-card{background:white;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);max-width:600px;margin:30px auto}
.summary{display:flex;flex-wrap:wrap;justify-content:space-around;margin-bottom:20px}
.summary div{flex:1 1 30%;text-align:center;padding:15px;margin:5px;background:#fff3e0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.table{width:100%;margin-bottom:1rem;color:#212529;border-collapse:collapse}
.table th,.table td{padding:.75rem;vertical-align:top;border:1px solid #dee2e6}
.table th{text-align:left}
.table-responsive{overflow-x:auto}
.dropdown-select{padding:.375rem .75rem;font-size:1rem;border-radius:.25rem;border:1px solid #ced4da;width:100%;margin-bottom:1rem}
footer{background:linear-gradient(to right,#ff512f,#f09819);color:white;text-align:center;padding:15px;margin-top:auto}
.text-center{text-align:center}
.btn{padding:.375rem .75rem;border-radius:.25rem;border:none;cursor:pointer}
.btn-warning{background:#ffc107;color:#212529}
.btn-danger{background:#dc3545;color:#fff}
.btn-light{background:#f8f9fa;color:#212529}
.w-100{width:100%}
.mb-3{margin-bottom:1rem}
.mt-3{margin-top:1rem}
.d-none{display:none}
</style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <div><img src="images/shriapp.png" alt="SHRI Logo"></div>
  <div>
    <a class="nav-link" href="index.html">Home</a>
    <a class="nav-link" href="about.html">About</a>
    <a class="nav-link" href="services.html">Services</a>
    <a class="nav-link" href="contact.html">Contact</a>
    <a class="nav-link" href="privacy.html">Privacy Policy</a>
    <a class="nav-link active" href="myaccount.html">My Account</a>
  </div>
</div>

<main class="container">

  <!-- Login -->
  <div class="login-container" id="loginBox">
    <h2 class="text-center" style="color:#ff512f;">My Account</h2>
    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" id="username" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" id="password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-warning w-100">Login</button>
    </form>
  </div>

  <!-- User Card -->
  <div class="user-card d-none" id="userCard">

    <!-- Senior Employee Dropdown -->
    <select class="dropdown-select d-none" id="employeeSelect"></select>

    <!-- Summary -->
    <div class="summary">
      <div><strong>Pali</strong><br><span id="paliCount">0</span></div>
      <div><strong>Upad</strong><br><span id="upadTotal">0</span></div>
      <div><strong>Balance</strong><br><span id="balanceTotal">0</span></div>
    </div>

    <!-- Detail Table -->
    <div class="table-responsive">
      <table class="table" id="detailTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Shift</th>
            <th>Customer</th>
            <th>Detail</th>
            <th>Payment</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Salary Slip Button -->
    <button class="btn btn-light w-100 d-none" id="downloadPDF">Download Salary Slip</button>

  </div>

</main>

<footer>
  <p>&copy; 2025 SHRI. All Rights Reserved.</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// CSV Links
const registrationCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLdyByIkGxCAIw8k8FQD8E9Tsnbc3DYks0dNgEhJcRikon38lOsqb4ESJAOlC7HwJylivfI49wrG5A/pub?gid=1862107016&single=true&output=csv";
const dailyInputCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLdyByIkGxCAIw8k8FQD8E9Tsnbc3DYks0dNgEhJcRikon38lOsqb4ESJAOlC7HwJylivfI49wrG5A/pub?gid=1370536424&single=true&output=csv";

const loginBox = document.getElementById("loginBox");
const userCard = document.getElementById("userCard");
const employeeSelect = document.getElementById("employeeSelect");
const downloadPDF = document.getElementById("downloadPDF");

let registrationData=[], dailyData=[];

function parseCSV(data){
  const lines = data.trim().split("\n");
  const headers = lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(",").map(c=>c.trim());
    let obj={};
    headers.forEach((h,i)=>obj[h]=cols[i]||"");
    return obj;
  });
}

Promise.all([fetch(registrationCSV).then(r=>r.text()), fetch(dailyInputCSV).then(r=>r.text())])
.then(([regTxt,dailyTxt])=>{
  registrationData=parseCSV(regTxt);
  dailyData=parseCSV(dailyTxt);
});

// Login
document.getElementById("loginForm").addEventListener("submit", function(e){
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const user = registrationData.find(u=>u.employee===username && u.Password===password);
  if(!user){alert("Username or password incorrect!"); return;}

  loginBox.classList.add("d-none");
  userCard.classList.remove("d-none");

  const role = user.Role.toLowerCase();
  if(role==="senior"){
    employeeSelect.classList.remove("d-none");
    downloadPDF.classList.remove("d-none");
    employeeSelect.innerHTML = `<option value="${user.employee}">${user.employee}</option>`+
      registrationData.filter(u=>u.Role.toLowerCase()==="employee").map(u=>`<option value="${u.employee}">${u.employee}</option>`).join("");
    employeeSelect.addEventListener("change", ()=>renderDashboard(employeeSelect.value));
    renderDashboard(user.employee);
  }else if(role==="employee"){
    renderDashboard(user.employee);
  }else if(role==="customer"){
    renderCustomer(user.customer);
  }
});

function renderDashboard(username){
  const user = registrationData.find(u=>u.employee===username);
  const daily = dailyData.filter(d=>d.Name===username);

  let paliCount=0;
  daily.forEach(d=>{paliCount+=(d.Morning?1:0)+(d.Evening?1:0)+(d.Night?1:0)});
  const upadTotal=daily.reduce((sum,d)=>sum+(parseFloat(d.Payment)||0),0);
  const balanceTotal=(paliCount*parseFloat(user.rate||0)-upadTotal)+(parseFloat(user['e-refferal'])||0)+(parseFloat(user['c-refferal'])||0);

  document.getElementById("paliCount").innerText=paliCount;
  document.getElementById("upadTotal").innerText=upadTotal.toFixed(2);
  document.getElementById("balanceTotal").innerText=balanceTotal.toFixed(2);

  const tbody=document.querySelector("#detailTable tbody");
  tbody.innerHTML="";
  daily.forEach(d=>{
    const shifts=[];
    if(d.Morning) shifts.push("Morning");
    if(d.Evening) shifts.push("Evening");
    if(d.Night) shifts.push("Night");
    tbody.innerHTML+=`<tr>
      <td>${d.Date}</td>
      <td>${shifts.join(", ")}</td>
      <td>${d.Customer}</td>
      <td>${d.Detail}</td>
      <td>${d.Payment}</td>
    </tr>`;
  });
}

// Customer view
function renderCustomer(username){
  const user = registrationData.find(u=>u.customer===username);
  const daily = dailyData.filter(d=>d.Customer===username);
  let totalPali=0;
  daily.forEach(d=>{totalPali+=(d.Morning?1:0)+(d.Evening?1:0)+(d.Night?1:0)});
  const advance=daily.reduce((sum,d)=>sum+(parseFloat(d.Payment)||0),0);
  const rate=parseFloat(user.rate||0);
  const bill=totalPali*rate-advance;

  document.getElementById("paliCount").innerText=totalPali;
  document.getElementById("upadTotal").innerText=advance.toFixed(2);
  document.getElementById("balanceTotal").innerText=bill.toFixed(2);

  const tbody=document.querySelector("#detailTable tbody");
  tbody.innerHTML="";
  daily.forEach(d=>{
    const shifts=[];
    if(d.Morning) shifts.push("Morning");
    if(d.Evening) shifts.push("Evening");
    if(d.Night) shifts.push("Night");
    tbody.innerHTML+=`<tr>
      <td>${d.Date}</td>
      <td>${shifts.join(", ")}</td>
      <td>${d.Name}</td>
      <td>${d.Detail}</td>
      <td>${d.Payment}</td>
    </tr>`;
  });
}

// Salary Slip PDF
downloadPDF.addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text(`Salary Slip - ${employeeSelect.value}`, 10, 10);
  doc.text(`Pali: ${document.getElementById("paliCount").innerText}`,10,20);
  doc.text(`Upad: ${document.getElementById("upadTotal").innerText}`,10,30);
  doc.text(`Balance: ${document.getElementById("balanceTotal").innerText}`,10,40);
  let y=50;
  const rows=document.querySelectorAll("#detailTable tbody tr");
  rows.forEach(tr=>{
    const cols=Array.from(tr.children).map(td=>td.innerText);
    doc.text(cols.join(" | "),10,y);
    y+=10;
  });
  doc.save(`${employeeSelect.value}-salary.pdf`);
});
</script>

</body>
</html>
