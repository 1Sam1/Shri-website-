<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Account</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 8px; margin: 5px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>

  <div id="account" style="display:none;">
    <h2>Welcome, <span id="empName"></span></h2>
    <p><b>Shifts (Pali):</b> <span id="pali"></span></p>
    <p><b>Advance (Upad):</b> ₹<span id="upad"></span></p>
    <p><b>Balance:</b> ₹<span id="balance"></span></p>

    <h3>Details</h3>
    <table id="detailsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Morning</th>
          <th>Evening</th>
          <th>Night</th>
          <th>Details</th>
          <th>Customer</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const dailyUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbEW2FWMXnxb8SKLMv0rxL3f0ZI8NntDpEhh9um5YAoZ7Nzki3NGFbReLqaV8Fkw/pub?gid=1370536424&single=true&output=csv";
    const regUrl   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbEW2FWMXnxb8SKLMv0rxL3f0ZI8NntDpEhh9um5YAoZ7Nzki3NGFbReLqaV8Fkw/pub?gid=1862107016&single=true&output=csv";

    let registrationData = [];
    let dailyData = [];

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text) {
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      return rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = (r[i] || "").trim());
        return obj;
      });
    }

    function safeNum(val) {
      if (!val) return 0;
      val = val.toString().trim();
      if (val === "" || val.toLowerCase() === "blank") return 0;
      return isNaN(val) ? 0 : parseFloat(val);
    }

    async function loadData() {
      registrationData = await fetchCSV(regUrl);
      dailyData = await fetchCSV(dailyUrl);
    }

    function calculateTotals(username) {
      const regRow = registrationData.find(r => r["employee"] === username);
      if (!regRow) return { pali: 0, upad: 0, balance: 0 };

      let pali = 0, upad = 0;
      dailyData.forEach(row => {
        if (row["Name"] === username) {
          pali += safeNum(row["morning"]) + safeNum(row["evening"]) + safeNum(row["night"]);
          upad += safeNum(row["amount"]);
        }
      });

      const rate = safeNum(regRow["rate"]);
      const balance = (pali * rate) - upad + safeNum(regRow["Last Month Balance"]);
      return { pali, upad, balance };
    }

    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();

      const regRow = registrationData.find(r => r["employee"] === user && r["Password"] === pass);
      if (!regRow) {
        alert("Invalid username or password");
        return;
      }

      document.getElementById("empName").innerText = user;
      const totals = calculateTotals(user);

      document.getElementById("pali").innerText = totals.pali;
      document.getElementById("upad").innerText = totals.upad.toFixed(2);
      document.getElementById("balance").innerText = totals.balance.toFixed(2);

      const tbody = document.querySelector("#detailsTable tbody");
      tbody.innerHTML = "";
      dailyData.forEach(row => {
        if (row["Name"] === user) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row["Date"]}</td>
            <td>${safeNum(row["morning"])}</td>
            <td>${safeNum(row["evening"])}</td>
            <td>${safeNum(row["night"])}</td>
            <td>${row["details"] || ""}</td>
            <td>${row["customer"] || ""}</td>
            <td>${row["amount"] || "0"}</td>
          `;
          tbody.appendChild(tr);
        }
      });

      document.getElementById("account").style.display = "block";
    }

    loadData();
  </script>
</body>
</html>
